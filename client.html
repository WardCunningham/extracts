<html>
<head>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸŸ¡</text></svg>">
</head>
<body>
  <style>
    body { font-family: "Helvetica Neue", Verdana, helvetica, Arial, Sans; }
    pre { white-space: pre-wrap; }
  </style>
  <p>
    <button onclick=remaining()>remaining extracts</button>
    <button onclick=latest()>latest failures</button>
  </p>
  <div id=result></div>

<script type=module>

  window.remaining = function() {
    window.result.innerHTML = `<center><img width:90% src=/result.svg?cache=${Math.random()}></center>`
  }

  window.latest = async function() {
    let results = await fetch(`/latest.json`).then(res => res.json())
    let logs = results.facets.map(result => {
      let {name, results} = result
      let [log,timestamp,exitStatus,elapsed,type] = results.map(obj => obj.latest)
      return {name,log,timestamp,exitStatus,elapsed,type}
    })
    logs = logs.filter(e => e.type != 'transform')
    logs.sort((a,b) => a.timestamp - b.timestamp)
    let prev = null
    let run = event => Math.floor(event.timestamp / (6*60*60*1000))
    function sepx(event) {
      let mark = run(prev||logs[0]) != run(event)
      prev = event
      return mark ? '<br>' : ''
    }
    let html = logs.map(e => `
      ${sepx(e)}
      <details>
        <summary>${new Date(e.timestamp).toLocaleString()} &nbsp; <b>${e.name}</b></summary>
        <p><button onclick="alltask('${e.name}')">all for one month</button></p>
        <pre>${e.log}</pre>
      </details>`
    )
    window.result.innerHTML = html.join("\n")
  }

  window.alltask = async function(task) {
    let results = await fetch(`/history.json?task=${task.replace(/ /g,'%20')}`).then(res => res.json())
    let logs = results.results[0].events.map(event => {
      let {elapsed, exitStatus,log,timestamp,task} = event
      return {name:task,log,timestamp,exitStatus,elapsed}
    })
    logs.sort((a,b) => a.timestamp - b.timestamp)
    let prev = null
    let run = event => Math.floor(event.timestamp / (24*60*60*1000))
    function sepx(event) {
      let mark = run(prev||logs[0]) != run(event)
      prev = event
      return mark ? '<br>' : ''
    }
    let html = logs.map(e => `
      ${sepx(e)}
      <details>
        <summary>
          ${new Date(e.timestamp).toLocaleString()} &nbsp;
          ${e.exitStatus == 0 ? '0' : `<font color=red>${e.exitStatus}</font>`}
          ${e.elapsed.toFixed(1)}
          <b>${e.name}</b>
        </summary>
        <pre>${e.log}</pre>
      </details>`
    )
    window.result.innerHTML = html.join("\n")
  }

</script>
</body>
</html>